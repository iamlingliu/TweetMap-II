var AWS = require('aws-sdk');
AWS.config.update({region: 'us-east-1'})
var sns = new AWS.SNS({region: 'us-east-1'});
var AlchemyAPI = require('./alchemyapi');
var alchemyapi = new AlchemyAPI();


var Consumer = require('sqs-consumer');
const snsPublish = require('aws-sns-publish');

var app = Consumer.create({
  queueUrl: 'xxx',
  region: 'us-west-2',
  batchSize: 3,
  handleMessage: function(message, done) {
    var tweet = JSON.parse(message.Body);
    alchemyapi.sentiment('text', tweet.text, {}, function(response) {
      if (response.status === 'OK') {
        tweet.sentiment = response.docSentiment.type;
        console.log(tweet.sentiment)
        snsPublish(tweet, {arn: 'xxx'}).then(messageId => {
            console.log(messageId);
        }, function(err) {
          console.log(err, err.stack);
        });
      }
    });
    done();
  }
});
 
app.on('error', function(err) {
  console.log(err.message);
});
 
app.start();